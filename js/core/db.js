(function($) {

	window.gl = window.gl || {};

	//////////////////////////////////////////////////////////////////////
	// Interface
	//////////////////////////////////////////////////////////////////////	
	window.gl.db = {

		//////////////////////////////////////////////////////////////////////
		getUserId: function(callback) {
			gl.invoke('db', 'getUserId', [], callback);
		},

		//////////////////////////////////////////////////////////////////////
		setUserId: function(id) {
			gl.invoke('db', 'setUserId', [id]);
		},

		//////////////////////////////////////////////////////////////////////
		getCredentials: function(callback) {
			gl.invoke('db', 'getCredentials', [], callback);
		},

		//////////////////////////////////////////////////////////////////////
		setCredentials: function(login, password) {
			gl.invoke('db', 'setCredentials', [login, password]);
		},

		//////////////////////////////////////////////////////////////////////
		getLocation: function(callback) {
			gl.invoke('db', 'getLocation', [], callback);
		},

		//////////////////////////////////////////////////////////////////////
		setLocation: function(location) {
			gl.invoke('db', 'setLocation', [location]);
		}

	};
	
	//////////////////////////////////////////////////////////////////////	
	// Core
	//////////////////////////////////////////////////////////////////////
	window.gl.db.core = {

		//////////////////////////////////////////////////////////////////////
		getUserId: function(callback) {
			var id = parseInt(localStorage.userId);

			callback(isNaN(id) ? -1 : id);
		},

		//////////////////////////////////////////////////////////////////////
		setUserId: function(id) {
			id = parseInt(id);
			if (!isNaN(id)) {
				localStorage.userId = id;
			}
		},

		//////////////////////////////////////////////////////////////////////
		getCredentials: function(callback) {
			var login = localStorage.login;
			var password = localStorage.password;
			
			if (isNonEmptyString(login) && isNonEmptyString(password)) {
				callback(login, password);
			} else {
				callback('', '');
			}
		},

		//////////////////////////////////////////////////////////////////////
		setCredentials: function(login, password) {
			if (login != null && password != null) {
				localStorage.login = login;
				localStorage.password = password;
			}
		},

		//////////////////////////////////////////////////////////////////////
		getLocation: function(callback) {
			var location = localStorage.location;

			if (isNonEmptyString(location)) {
				callback(location);
			} else {
				callback(window.gl.location.locations[0].name);
			}
		},

		//////////////////////////////////////////////////////////////////////
		setLocation: function(location) {
			if (isNonEmptyString(location)) {
				localStorage.location = location;
			}
		}

	};

	//////////////////////////////////////////////////////////////////////
	// Helpers
	//////////////////////////////////////////////////////////////////////
	function isNonEmptyString(value) {
		return (typeof value == 'string') && value.length > 0;
	}

})(jQuery)
