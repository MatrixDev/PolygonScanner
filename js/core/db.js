(function($) {

	window.gl = window.gl || {};

	//////////////////////////////////////////////////////////////////////
	// Interface
	//////////////////////////////////////////////////////////////////////	
	window.gl.db = {

		//////////////////////////////////////////////////////////////////////
		getUserId: function(callback) {
			gl.invoke('db', 'getUserId', [], callback);
		},

		//////////////////////////////////////////////////////////////////////
		setUserId: function(id) {
			gl.invoke('db', 'setUserId', [id]);
		},

		//////////////////////////////////////////////////////////////////////
		getCredentials: function(callback) {
			gl.invoke('db', 'getCredentials', [], callback);
		},

		//////////////////////////////////////////////////////////////////////
		setCredentials: function(login, password) {
			gl.invoke('db', 'setCredentials', [login, password]);
		},

		//////////////////////////////////////////////////////////////////////
		getLocation: function(callback) {
			gl.invoke('db', 'getLocation', [], callback);
		},

		//////////////////////////////////////////////////////////////////////
		setLocation: function(location) {
			gl.invoke('db', 'setLocation', [location]);
		},

		//////////////////////////////////////////////////////////////////////
		getTimeWraps: function(callback) {
			gl.invoke('db', 'getTimeWraps', [], callback);
		},

		//////////////////////////////////////////////////////////////////////
		setTimeWraps: function(wraps) {
			gl.invoke('db', 'setTimeWraps', [wraps]);
		}

	};
	
	//////////////////////////////////////////////////////////////////////	
	// Core
	//////////////////////////////////////////////////////////////////////
	window.gl.db.core = {

		//////////////////////////////////////////////////////////////////////
		getUserId: function(callback) {
			var id = parseInt(localStorage.userId, 10);

			callback(isNaN(id) ? -1 : id);
		},

		//////////////////////////////////////////////////////////////////////
		setUserId: function(id) {
			id = parseInt(id, 10);
			if (!isNaN(id)) {
				localStorage.userId = id;
			}
		},

		//////////////////////////////////////////////////////////////////////
		getCredentials: function(callback) {
			var login = localStorage.login;
			var password = localStorage.password;
			
			if (isNonEmptyString(login) && isNonEmptyString(password)) {
				callback(login, password);
			} else {
				callback('', '');
			}
		},

		//////////////////////////////////////////////////////////////////////
		setCredentials: function(login, password) {
			if (login != null && password != null) {
				localStorage.login = login;
				localStorage.password = password;
			}
		},

		//////////////////////////////////////////////////////////////////////
		getLocation: function(callback) {
			var location = localStorage.location;

			if (isNonEmptyString(location)) {
				callback(location);
			} else {
				callback(window.gl.location.all[0].name);
			}
		},

		//////////////////////////////////////////////////////////////////////
		setLocation: function(location) {
			if (isNonEmptyString(location)) {
				localStorage.location = location;
			}
		},

		//////////////////////////////////////////////////////////////////////
		getInstallTime: function() {
			return localStorage.installTime;
		},

		//////////////////////////////////////////////////////////////////////
		setInstallTime: function(time) {
			localStorage.installTime = time;
		},

		//////////////////////////////////////////////////////////////////////
		getTimeWraps: function(callback) {
			var wraps = JSON.parse(localStorage.timeWraps || '{}');
			if (!(wraps instanceof Array) || !(wraps[0] instanceof Array)) {
				wraps = [[1, 1, 1, 1, 1, 1, 1]];
			}
			callback(wraps);
		},

		//////////////////////////////////////////////////////////////////////
		setTimeWraps: function(wraps) {
			localStorage.timeWraps = JSON.stringify(wraps);
		}

	};

	//////////////////////////////////////////////////////////////////////
	// Helpers
	//////////////////////////////////////////////////////////////////////
	function isNonEmptyString(value) {
		return (typeof value == 'string') && value.length > 0;
	}

})(jQuery)
